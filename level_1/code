
fs = 20000;
frameSize = 1024;
noiseFrames = 50;
maxDuration = 10; 
maxSamples = maxDuration * fs;

mainAudio = zeros(maxSamples,1);
filteredAudio = zeros(maxSamples,1);

deviceReader = audioDeviceReader('SampleRate', fs, 'SamplesPerFrame', frameSize);

disp('Start noise estimation, keep silent...');
noiseSpec = zeros(frameSize,1);
for i = 1:noiseFrames
    frame = deviceReader();
    frameFFT = fft(frame);
    noiseSpec = noiseSpec + abs(frameFFT);
end
noiseSpec = noiseSpec / noiseFrames;
disp('Noise estimation complete. Start speaking!');

recording = true;
sampleIndex = 1;

while recording && (sampleIndex + frameSize -1) <= maxSamples
    frame = deviceReader();
    
    frameFFT = fft(frame);
    mag = abs(frameFFT) - noiseSpec;
    mag = max(mag, 0);
    phase = angle(frameFFT);
    filteredFrame = real(ifft(mag .* exp(1i*phase)));
    
    mainAudio(sampleIndex : sampleIndex+frameSize-1) = frame;
    filteredAudio(sampleIndex : sampleIndex+frameSize-1) = filteredFrame;
    
    sampleIndex = sampleIndex + frameSize;
    
    if mod(sampleIndex, fs*5) == 1
        str = input('Type K then Enter to stop or just Enter to continue: ', 's');
        if strcmpi(str, 'K')
            recording = false;
            disp('Recording stopped.');
        end
    end
end

mainAudio = mainAudio(1:sampleIndex-1);
filteredAudio = filteredAudio(1:sampleIndex-1);

audiowrite('main_audio.wav', mainAudio, fs);
audiowrite('filtered_audio.wav', filteredAudio, fs);
disp('Files saved: main_audio.wav and filtered_audio.wav');

